# Kotlin Collection Manager Server

Серверная часть клиент-серверного приложения для работы с абстрактными коллекциями

## Описание

Этот проект был создан в рамках обучения, чтобы изучить Kotlin, лучше понять фреймворк Spring Boot, получить практический опыт разработки приложений с микросервисной архитектурой, а также познакомится с принципами работы систем обмена сообщенями (Apache Kafka) и принципами аспектно-оринтированного программирования.
Представляет из себя микросервисное backend-приложение, реализованное на Kotlin, которое обеспечивает управление коллекциями (в данном случае коллекцией квартир).

## Технологии
- Kotlin
- Spring Boot + Starters (Web, Security, Data, Kafka, AOP)
- Apache Kafka
- Premetheus
- Grafana
- Postgresql

## Архитектура

### File-service

Сервис, который обеспечивает доступ других сервисов к данным из базы данных, по сути реализует слой доступа к данным (DAL) для изоляции БД от прямого внешнего воздействия. По запросу выдает данные из БД в сериализованном виде, а также принимает измененные версии коллекций и вносит их в базу. Для обеспечения аудита и возможности восстановления состояния коллекции, сервис кеширует версии коллекций, фиксируя их состояние во времени.

После запуска начинает слушать Kafka-топики `SYSTEM` и `COLLECTION_UPDATE`. Благодаря первому топику отслеживает состояние других сервисов и сообщает им о готовности обмена данными, благодаря второму - получает ивенты с обновленными версиями коллекции и вносит изменения в БД.

Предоставляет для внешних сервисов ряд Http-эндпонтов:

#### `Auth контроллер` — предоставляет методы для авторизации пользователя
- `/login` — метод для обеспечения авторизации пользователя. Принимает в себя объект `AuthUserDto(val email: String, var password: String?)` и при успешной авторизации возвращает `UserTokensDto(val accessToken: String, val refreshToken: String)` — JWT access и refresh токены для доступа к остальным методам API
- `/register` — метод для регистрации нового пользователя. Также как и `login`, принимает в себя объект `AuthUserDto(val email: String, var password: String?)`, при успешной регистрации возвращает `UserTokensDto`
- `/updateJwtTokens` - метод для обновления JWT токенов пользователя. Принимает в себя `token: String` и при успешной валидации токена возвращает новую пару токенов в виде `UserTokensDto`

#### `Users контроллер` — предоставляет набор методов-геттеров для получения данных пользователей

- `/getAll` — получение данных всех пользователей
- `/{id}` <==> `/getById/{id}` — получение данных пользователя по его `id`
- `/getByEmail/{email}` — получение данных пользователя по его `email`

#### `Flats контроллер` — предоставляет набор CRUD операций для управления коллекцией квартир

- `/getAll` — получение всех записей о квартирах
- `/getAllByUserId` — получение записей о квартирах, созданных конкретным пользователем (`id` пользователя берется из заголовка запроса, при верификации access jwt-токена)
- `/getFlatById/{id}` — получение записи конкретной квартиры по её `id`
- `/create` - создание новой записи о квартире
- `/update` — обновление существующей записи о квартире
- `/delete/{id}` — удаление квартиры по её `id`
- `/deleteAll` — удаление всех квартир коллекции

---

### Collection-service

Сервис, обеспечивающий изменение данных в инстансе коллекции. При запуске также подписывается на kafka-топики `SYSTEM` и `COLLECTION_UPDATE`, после чего получает от file-сервиса копию текущей коллекции и сохраняет ее локально, дальнейшая работа происходит уже с копией. Дополнительно подписывается на топик `COMMANDS_SYNCHRONIZATION` для снабжения данными о доступных командах `invoker-service`. 

Сервис также предоставляет ряд http-эндпоинтов для управления коллекцией, каждый метод, который должен быть доступен для invoker-сервиса (сервиса, отвечающего за работу пользователя с командной строкой) помечается аннотациями `@CommandEndpoint` и `@CommandDescription`.

- `@CommandEndpoint` — аннотация, которой помечается метод, который должен быть включен в список доступнях для командной строки методов. Использует в качестве имени доступной команды имя метода, к которому была применена аннотация
- `@CommandDescription` — используется вместе с `@CommandEndpoint` в случае, если помимо имени команды нужно также передать ее описание. Принимает в себя `description: String` — описание команды.

Помимо предоставления API для `invoker-сервиса`, данный сервис также уведомляет `file-сервис` о внесении изменений в коллекцию. Отслеживается это при помощи аспекта `CollectionChangesAspect`. После выполнения методов, помеченных аннотацией `@ChangingCollection` срабатывает аспект, который подготавливает новую версию коллекции и отправляет ее в `COLLECTION_UPDATE` топик, где её уже получает `file-сервис` и вносит изменения в базу. 

Таким образом удалось не только разделить бизнес-логику от логики доступа к данным, но также обеспечить слабую связанность между сервисами и внедрить удобных механизм синхронизции, который в дальнейшем можно будет легко переделать или как-либо дополнить.


--- 

### Invoker-service

Сервис, реализущий "прослойку" между клиентом и сервером. Реализует интерфейс `CommandLineRunner` и предоставляет пользователю доступ к командной строке, через которую он может получить доступ к доступной ему коллекции квартир (в более свежем релизе invoker-сервис выступает в роли TCP сервера для работы с клиентской частью приложения (GUI))

При запуске получает набор доступных команд от `collection-сервиса`. Выполняет первичную валидацию данных, а также поддерживает работу с файлами, содержищие готовые наборы команд для выполнения.
